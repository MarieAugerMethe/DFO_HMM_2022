---
title: "Hidden Markov Models: Missing data and multiple data streams"
editor_options:
  chunk_output_type: console
output:
  html_document:
    number_sections: true
  pdf_document: 
    number_sections: true
---

# Tutorial goals and set up

## objectives

-   Dealing irregular locations,

-   time gaps,

-   including diving covariates

-   narwhal data

# import data
First, we'll setup the workspace with required packages
```{r message=FALSE}
library(momentuHMM)
library(dplyr)
library(ggplot2)
library(lubridate)
library(adehabitatLT)
library(sf)
library(tmap)
```

```{r message=FALSE}
tracks <- read.csv("data/tracks.csv") %>%
  filter(!is.na(x) & !is.na(y)) %>% # remove missing locations
  mutate(
    time = ymd_hms(time), # define time
    sameid = id == lead(id),
    dt = ifelse(id == lead(id), # If next data point is same individual
      difftime(lead(time), time, units = "mins"), NA), # calculate difference in time
    loc_class = factor(loc_class, # define location class factor levels
      levels = c("GPS", 3, 2, 1, 0, "A", "B"))) %>%
  st_as_sf(coords = c("x", "y")) %>% # converts to an sf object
  st_cast("POINT") %>%
  st_set_crs(4326) %>% # define CRS
  st_transform(26918) # reproject data to a UTM
```

The classic HMM assumes the observation data is in discrete time and that there is no missing data in the predictor variables 
```{r}
hist(tracks$dt, 1000)
hist(subset(tracks, dt < 60 & dt > 0)$dt, 60)
```

```{r message=FALSE}
# convert to lines/paths
tracks %>% group_by(id) %>% 
  summarise(do_union = F) %>% 
  st_cast("LINESTRING") %>% 
  # plot
     tm_shape()+
   tm_lines(col = "id", palette = "Dark2")
```


```{r message=FALSE}




# # plot with ggplot
# tracks %>% 
#   mutate(x = st_coordinates(tracks)[,"X"],  # convert back to dataframe
#          y = st_coordinates(tracks)[,"Y"]) %>% 
#   ggplot(aes(
#     x = x, y = y, col = factor(id)), stroke = NA) +
#   geom_path()
# explore palettes 
if (require(shiny) && require(shinyjs)) {
     tmaptools::palette_explorer()
}

#### impute missing locations ####
# offset duplicate times by 10s
tracks <- tracks %>%
  mutate(time = time + 10*replace_na(lag(cumsum(dt==0)*(dt==0)), 0))

# course speed filter
tracks %>% 
  mutate(spd = sqrt(lag()))
# fit crawl model 
crwOut.win1<- crawlWrap(tracks, ncores = ncores, err.model = err.model,Time.name = "date_time",
            prior = prior, predTime = predTimes_2hour, attempts = 150 , retryFits = 30, proj=6103)
crwOut.win1

i <- 2; error <- T
while(error == T){
  tryCatch({
    i <- i+1
    set.seed(i)
    crwOut <- crawlWrap(obsData = pb, timeStep = "4 hours")  #4 hours
    error <- F
  },
  error = function(e){message(paste("On seed number:", i))}
  )
}

# first passage time
tracks <- filter(tracks, dt !=0, Loc.Class %in% c("GPS", 3, 2))
ltraj <- as.ltraj(xy = cbind(st_coordinates(tracks)[,"X"],
                             st_coordinates(tracks)[,"Y"]),
                  date = tracks$time, id=factor(tracks$DeployID))
fpt_low <- fpt(ltraj, seq(100, 5000, length=100), units = "hours") %>% 
  varlogfpt() TT 
fpt_med <- fpt(ltraj, seq(5000, 20000, length=200), units = "hours") %>% 
  varlogfpt()
fpt_hig <- fpt(ltraj, seq(20000, 100000, length=200), units = "hours") %>% 
  varlogfpt()
fpt_max <- fpt(ltraj, seq(100000, 150000, length=100), units = "hours") %>% 
  varlogfpt()
fpt(ltraj, 40000, units = "hours") %>% plot(40000)
# looks like there are are increases/plateaus of variance at around 1.5, 13, 40, & 80 km
```

```{r Load data, warning=FALSE}
dives <- read.csv("data/dives.csv")
```
## different resolutions, different questions
## visualise data
## assess data structure (resolution/gaps)
## brainstorm methods to merge data streams (same resolution, hierarchical)
## brainstorm methods to select resolution
## brainstorm methods to fill missing data (NA, linear interpolation, imputation, multiple imputation, track segmentation)
## basic HMM (only locs)
## brainstorm HMM development (dive-only HMM, or add dives to locs, covariates to add; covs to TPM & DS (eg angle bias))
## setup tutorial development issue thread
```{r}

```
